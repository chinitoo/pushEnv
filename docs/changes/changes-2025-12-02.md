# Changes - 2025-12-02

## Add-Stage Command & Safety Improvements

### What Changed

Added a new `pushenv add-stage` command to add new stages/environments to an existing project without reinitializing. This preserves the project ID and encryption keys while allowing teams to add production, staging, or other environments later.

Also improved the `pushenv init` command with automatic safety features to prevent using plain `.env` for stage-specific configurations.

**Files Added:**
- `src/commands/add-stage.ts` - New command to add stages to existing projects

**Files Modified:**
- `src/commands/init.ts` - Added auto-rename feature that suggests `.env.{stage}` instead of plain `.env`
- `src/cli.ts` - Registered the new `add-stage` command
- `README.md` - Updated documentation with new command and safety features

### Why It Changed

**Problem 1: Reinitializing was destructive**
- Previously, to add a new stage (like production) after initial setup, users had to run `pushenv init` again
- This would generate a NEW project ID and encryption key
- Old encrypted data in cloud storage would be orphaned and inaccessible
- No way to safely extend an existing configuration

**Problem 2: Plain `.env` files are dangerous for multiple stages**
- Users keeping secrets in a single `.env` file and manually swapping content is error-prone
- Risk of pushing development secrets to production or vice versa
- No protection against this common mistake

### How It Affects the Current Code

**Add-Stage Command:**
- Reads existing project configuration
- Shows which stages are already configured
- Prompts for new stage selection and file path
- Updates `.pushenv/config.json` without changing project ID or keys
- Creates new `.env.{stage}` file if needed
- Preserves all existing stage configurations and cloud storage paths

**Init Command Safety:**
- Now defaults to `.env.{stage}` instead of plain `.env` (even for single stage)
- If user enters `.env`, shows a warning about risks
- Offers to automatically rename existing `.env` → `.env.{stage}`
- If user accepts, performs the rename and updates config
- Makes it much harder to accidentally use the same file for multiple stages

### Developer Notes

**Usage Examples:**

```bash
# Add production stage to existing project
pushenv add-stage
# Select 'production' from list
# Enter file path (defaults to .env.production)
# Creates .env.production if it doesn't exist

# Initialize with safety (auto-suggests .env.development)
pushenv init
# Select stages
# Gets .env.development, .env.staging, .env.production as defaults
# Warns if you try to use plain .env

# Check configured stages
pushenv list-stages
```

**Benefits:**

1. **Non-destructive stage addition** - Add production/staging/etc. without losing existing data
2. **Preserves project identity** - Same project ID means cloud storage paths stay consistent
3. **Safer defaults** - Automatically suggests stage-specific filenames
4. **Prevents common mistakes** - Warns about plain `.env` usage
5. **Team-friendly** - Team members can pull existing stages while you add new ones

**Next Steps:**

- Team members should run `pushenv list-stages` to see newly added stages
- Run `pushenv push --stage <new-stage>` to upload the new stage's secrets
- Consider adding stage verification to `push` command (warn if header stage doesn't match --stage parameter)
- Document migration path for teams currently using plain `.env`

**Migration for Existing Users:**

If you're currently using plain `.env` for a single stage:
1. Run `pushenv add-stage` to add new stages
2. Manually rename `.env` → `.env.development` (or appropriate stage name)
3. Update your `.pushenv/config.json` to point to the new filename
4. Run `pushenv push --stage development` to sync

**No Breaking Changes:**
- Existing configurations with plain `.env` continue to work
- Only affects new `init` runs and new stage additions
- Purely additive feature - no existing functionality removed

